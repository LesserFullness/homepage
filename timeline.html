<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æˆé•¿è½¨è¿¹</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>

  <h1 style="text-align:center;">ğŸ“… çŸ¥å‘¨çš„æ—¶é—´è½´</h1>
  <p style="text-align:center;">
  <a href="/index.html" target="_blank">è¿”å›é¦–é¡µ</a>
  </p>

  <!-- ğŸ” æœç´¢ -->
  <div style="text-align:center; margin-bottom: 20px;">
    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢äº‹ä»¶..." style="padding: 0.5rem; width: 60%; max-width: 400px;">
  </div>

  <!-- â• æ·»åŠ äº‹ä»¶ -->
  <div style="text-align:center; margin-bottom: 30px;">
    <h2>â• æ·»åŠ æ–°äº‹ä»¶</h2>
    <input type="text" id="dateInput" placeholder="å¦‚ 2025å¹´5æœˆ22æ—¥" style="margin: 5px; padding: 5px; width: 250px;"><br>
    <input type="text" id="textInput" placeholder="äº‹ä»¶æè¿°" style="margin: 5px; padding: 5px; width: 250px;"><br>
    <input type="file" id="imageInput" accept="image/*" style="margin: 5px; padding: 5px; width: 250px;"><br>
    <button id="addBtn" style="padding: 8px 16px;">æ·»åŠ äº‹ä»¶</button>
  </div>

  <!-- ğŸ“„ å¯¼å‡º PDF -->
  <div style="text-align:center; margin-bottom: 20px;">
    <button id="exportBtn" style="padding: 8px 16px;">å¯¼å‡ºä¸º PDF</button>
  </div>

  <!-- ğŸ“ å¯¼å…¥å¯¼å‡º JSON -->
  <div style="text-align:center; margin-bottom: 30px;">
    <input type="file" id="importJson" accept=".json" style="margin: 5px;">
    <button id="exportJsonBtn" style="padding: 8px 16px;">å¯¼å‡ºä¸º JSON</button>
  </div>

  <!-- æ—¶é—´è½´ -->
  <div class="timeline" id="timeline" style="max-width: 900px; margin: auto;"></div>

  <script>
    let allEvents = [];

    function parseDate(dateStr) {
      const match = dateStr.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
      if (match) {
        const [_, y, m, d] = match;
        return new Date(`${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`);
      }
      return new Date(dateStr);
    }

    function getLunarDate(dateStr) {
      const match = dateStr.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
      if (match) {
        const [_, y, m, d] = match;
        const solar = Lunar.Solar.fromYmd(parseInt(y), parseInt(m), parseInt(d));
        return solar.getLunar().toString();
      }
      return '';
    }

    function renderTimeline(data) {
      const container = document.getElementById("timeline");
      container.innerHTML = '';
      const sorted = [...data].sort((a, b) => parseDate(b.date) - parseDate(a.date));

      const grouped = sorted.reduce((acc, item) => {
        const year = item.date.slice(0, 4);
        if (!acc[year]) acc[year] = [];
        acc[year].push(item);
        return acc;
      }, {});
      const years = Object.keys(grouped).sort((a, b) => b - a);

      let count = 0;
      years.forEach(year => {
        container.insertAdjacentHTML('beforeend', `<h2 class="year-header">${year}</h2>`);
        grouped[year].forEach(item => {
          const side = count++ % 2 === 0 ? "left" : "right";
          const lunar = getLunarDate(item.date);
          const html = `
            <div class="entry ${side}">
              <h3>${item.date}</h3>
              <p>${item.text}</p>
              ${lunar ? `<p>å†œå†ï¼š${lunar}</p>` : ''}
              ${item.image ? `<img src="${item.image}" alt="${item.date}" style="max-width:100%; border-radius:8px;">` : ''}
            </div>
          `;
          container.insertAdjacentHTML("beforeend", html);
        });
      });
    }

    function loadLocalEvents() {
      const local = localStorage.getItem("timelineEvents");
      return local ? JSON.parse(local) : [];
    }

    function saveLocalEvents(events) {
      localStorage.setItem("timelineEvents", JSON.stringify(events));
    }

    function setupAddEvent() {
      document.getElementById("addBtn").addEventListener("click", () => {
        const date = document.getElementById("dateInput").value.trim();
        const text = document.getElementById("textInput").value.trim();
        const imageFile = document.getElementById("imageInput").files[0];
        if (!date || !text) {
          alert("è¯·è¾“å…¥æ—¥æœŸå’Œæè¿°ï¼");
          return;
        }

        const saveEvent = (imageBase64 = '') => {
          const newEvent = { date, text, image: imageBase64 };
          const localEvents = loadLocalEvents();
          localEvents.push(newEvent);
          saveLocalEvents(localEvents);
          allEvents.push(newEvent);
          renderTimeline(allEvents);
        };

        if (imageFile) {
          const reader = new FileReader();
          reader.onload = e => saveEvent(e.target.result);
          reader.readAsDataURL(imageFile);
        } else {
          saveEvent();
        }
      });
    }

    function addSearch(data) {
      document.getElementById("searchInput").addEventListener("input", () => {
        const keyword = document.getElementById("searchInput").value.toLowerCase();
        const filtered = data.filter(item =>
          item.date.includes(keyword) || item.text.toLowerCase().includes(keyword)
        );
        renderTimeline(filtered);
      });
    }

    function setupExport() {
      document.getElementById("exportBtn").addEventListener("click", () => {
        const { jsPDF } = window.jspdf;
        html2canvas(document.getElementById("timeline")).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF('p', 'mm', 'a4');
          const width = pdf.internal.pageSize.getWidth();
          const height = (canvas.height * width) / canvas.width;
          pdf.addImage(imgData, 'PNG', 0, 0, width, height);
          pdf.save("timeline.pdf");
        });
      });
    }

    function setupJsonImportExport() {
      const importInput = document.getElementById("importJson");
      const exportBtn = document.getElementById("exportJsonBtn");

      importInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
          try {
            const imported = JSON.parse(e.target.result);
            if (Array.isArray(imported)) {
              const merged = [...loadLocalEvents(), ...imported];
              saveLocalEvents(merged);
              allEvents = merged;
              renderTimeline(allEvents);
              alert("å¯¼å…¥æˆåŠŸï¼");
            } else {
              alert("æ— æ•ˆçš„ JSON æ–‡ä»¶ï¼");
            }
          } catch (err) {
            alert("è¯»å–å¤±è´¥ï¼š" + err.message);
          }
        };
        reader.readAsText(file);
      });

      exportBtn.addEventListener("click", () => {
        const dataStr = JSON.stringify(allEvents, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "timeline-events.json";
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    async function init() {
      let serverData = [];
      try {
        const res = await fetch("data.json");
        serverData = await res.json();
      } catch {
        console.warn("æœªèƒ½åŠ è½½ data.jsonï¼Œä½¿ç”¨ç©ºæ•°æ®ã€‚");
      }
      const userData = loadLocalEvents();
      allEvents = [...serverData, ...userData];
      renderTimeline(allEvents);
      addSearch(allEvents);
      setupAddEvent();
      setupExport();
      setupJsonImportExport();
    }

    init();
  </script>

  <style>
    .timeline { position: relative; padding: 20px 0; }
    .year-header { text-align: center; font-size: 1.5em; margin-top: 40px; }
    .entry {
      width: 45%; padding: 20px; margin: 20px;
      background: #f5f5f5; border-radius: 12px; box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    .left { float: left; clear: both; }
    .right { float: right; clear: both; }
    img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
  </style>

</body>
</html>
